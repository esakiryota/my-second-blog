{% load static %}
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>ホワイトボード</title>
    <link href='//fonts.googleapis.com/css?family=Lobster&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <link rel="stylesheet" href="{% static 'css/jquery.mCustomScrollbar.css'%}" />

    <!--Import jQuery Library-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <!-- <script src="/path/to/jquery.mCustomScrollbar.concat.min.js"></script> -->
    <!--Import materialize.js-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
    <!-- <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script> -->
    <style>
        body {
            font-family: sans-serif;
        }
    
        video {
            max-width: 100%;
            width: 200px;
            border-radius: 8px;
        }
    </style>
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RL1LQV6HMG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RL1LQV6HMG');
</script>


<body>
    <figure id="board" >
        <!-- <div id="zoom_in" style="left: 600px; position: absolute;"><i class="material-icons">zoom_in</i></div> -->
        <svg id="drawingCanvas" style="top: 10px; left: 100px; position: absolute; width: 90%; height: 90%;" class="z-depth-5"></svg>
        <div id="bottons" style="position: absolute; bottom: 50px; right: 50px;">
            <a class='pointer-type btn-floating row tooltipped blue button' href='#' data-position="right" data-delay="50" data-tooltip="全削除"
            id="eraserAll" ><i class="material-icons">delete_forever</i></a>
            <a class='pointer-type btn-floating row tooltipped blue button' href='#' data-position="right" data-delay="50" data-tooltip="戻る"
            id="redo"><i class="material-icons">redo</i></a>
            <a class='pointer-type btn-floating row tooltipped blue button' href='#' data-position="right" data-delay="50" data-tooltip="画像"
            id="image_catch"><i class="material-icons">photo</i></a>
        </div>
        <div id="controllers" class="row" style="position: absolute; top: 20px; right: 50px;">
            <span class='pointer-type col controller' id="zoom_in"><i class="material-icons">zoom_in</i></span>
            <span class='pointer-type col controller' id="moveScreen"><i class="material-icons">open_with</i></span>
        </div>
    </figure>
    <p style="position: fixed; left: 10px; top: 10px; display: flex; flex-flow: column;">
        <a class='dropdown-button btn row tooltipped' data-position="right" data-delay="50" data-tooltip="色"
            style="background-color: black;" href='#' data-activates='dropdown1' id="color-btn"><i
                class="material-icons">color_lens</i></a>
        <a class='dropdown-button pointer-type btn row tooltipped' data-position="right" data-delay="50" data-tooltip="ペン" href='#'
            id="draw" style="background-color: #2962ff;" data-activates='dropdown2'><i class="material-icons">edit</i></a>
        <!-- <a class='pointer-type btn row tooltipped' href='#' data-position="right" data-delay="50" data-tooltip="移動"
            id="moveScreen"><i class="material-icons">open_with</i></a> -->
        <a class='pointer-type btn row tooltipped' href='#' data-position="right" data-delay="50" data-tooltip="選択"
            id="moveContent" style="background-color: #42a5f5;"><i class="material-icons">pan_tool</i></a>
        <a class='pointer-type btn row tooltipped' href='#' data-position="right" data-delay="50" data-tooltip="削除"
            id="eraser" style="background-color: #42a5f5;"><i class="material-icons">delete</i></a>
        <!-- <a class='pointer-type btn row tooltipped' href='#' data-position="right" data-delay="50" data-tooltip="全削除"
            id="eraserAll"><i class="material-icons">delete_forever</i></a> -->
        <!-- <a class='pointer-type btn row tooltipped' href='#' data-position="right" data-delay="50" data-tooltip="戻る"
            id="redo"><i class="material-icons">redo</i></a> -->
        <!-- <a class='pointer-type btn row tooltipped' href='#' data-position="right" data-delay="50"
            data-tooltip="ズーム" id="zoom_in"><i class="material-icons">zoom_in</i></a> -->
        <a class='pointer-type btn row tooltipped' href='#' data-position="right" data-delay="50"
            data-tooltip="comming soon" style="background-color: #42a5f5;"><i class="material-icons">picture_in_picture</i></a>
        <a class='pointer-type btn row tooltipped' href='#' data-position="right" data-delay="50" data-tooltip="文字"
            id="text" style="background-color: #42a5f5;"><i class="material-icons">text_format</i></a>
        <!-- <a class='pointer-type btn row tooltipped' href='#' data-position="right" data-delay="50" data-tooltip="画像"
            id="image_catch"><i class="material-icons">photo</i></a> -->
        <input type="file" style="display: none;" accept="image/*" id="file-select-input">
        <!-- <a class="btn" onclick="Materialize.toast('I am a toast', 4000)">Toast!</a> -->
    <ul id='dropdown1' class='dropdown-content' style="width: 100px;">
        <li class="color" id="#000000"><a href="#!">
                <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #000000;"></div>
            </a></li>
        <li class="color" id="#ff0000"><a href="#!">
                <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #ff0000;"></div>
            </a></li>
        <li class="color" id="#008000"><a href="#!">
                <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #008000;"></div>
            </a></li>
        <li class="color" id="#0000ff"><a href="#!">
                <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #0000ff;"></div>
            </a></li>
        <li class="color" id="#ffff00"><a href="#!">
                <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #ffff00;"></div>
            </a></li>
        <li class="color" id="#FFFFFF"><a href="#!">
                <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #FFFFFF;"></div>
            </a></li>
    </ul>
    <ul id='dropdown2' class='dropdown-content' style="width: 100px;">
        <li class="size" id="3"><a href="#!" class="">
                <div style="width: 3px; height: 3px; border-radius: 50%; background-color: #000000;"></div>
            </a></li>
        <li class="size" id="6"><a href="#!">
                <div style="width: 6px; height: 6px; border-radius: 50%; background-color: #000000;"></div>
            </a></li>
        <li class="size" id="9"><a href="#!">
                <div style="width: 9px; height: 9px; border-radius: 50%; background-color: #000000;"></div>
            </a></li>
        <li class="size" id="12"><a href="#!">
                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #000000;"></div>
            </a></li>
        <li class="size" id="15"><a href="#!" class="">
                <div style="width: 15px; height: 15px; border-radius: 50%; background-color: #000000;"></div>
            </a></li>
        <li class="size" id="18"><a href="#!">
                <div style="width: 18px; height: 18px; border-radius: 50%; background-color: #000000;"></div>
            </a></li>
        <li class="size" id="21"><a href="#!">
                <div style="width: 21px; height: 21px; border-radius: 50%; background-color: #000000;"></div>
            </a></li>
        <li class="size" id="24"><a href="#!">
                <div style="width: 24px; height: 24px; border-radius: 50%; background-color: #000000;"></div>
            </a></li>
    </ul>
    </p>
    <div id="videos" style="position: fixed; left: 100px; top:20px; max-height: 500px; overflow:auto;">
        <div id="{{user_name}}_box" style="position: relative;">
            <video id="localVideo" class="z-depth-5" autoplay muted playsinline></video>
            <div style="position: absolute; bottom: 6px; left: 0px; background-color: black; color: white;" id="name_{{user_name}}">{{user}}</div>
            <div style="position: absolute; bottom: 0px; right: 0px;">
            <a class='' href='#' id="mic" style="color: white"><i class="material-icons">mic_off</i></a>
            <a class='' href='#' id="switch_video" style="color: white"><i class="material-icons">videocam</i></a>
            <a class='' href='#' id="visibility_{{user_name}}" style="color: white" class="visible"><i class="material-icons">visibility_off</i></a>
            </div>
            <div style="position: relative; top: 10px; left: 10px; margin: 10px; display: none" id="invisible_{{user_name}}">
                <span id="person_{{user_name}}" href='#' id="invisibility{{user_name}}" style="color: white" class="visible">
                    {% if image == "" %}
                    <i class="material-icons circle black" height="30" width="30">person</i>
                    {% else %}
                    <img src="{{image}}" alt="" class="circle" id="profile_image" style="object-fit: cover;" height="30" width="30">
                    {% endif%}
                </span>
            </div>
        </div>
</div>

    <!-- <script src="{% static 'js/materialize.js' %}"></script> -->
    <!-- <script src="{% static 'js/select.js' %}"></script> -->
    <script src="{% static 'js/jquery.mCustomScrollbar.js'%}"></script>
    {{ token|json_script:"token" }}
    {{ user_name|json_script:"user_name"}}
    {% csrf_token %}
    <script>
        $(function () {
            
            var svgElm_js = document.getElementById("drawingCanvas")
            svgElm_js.clientHeight = svgElm_js.style.height
            svgElm_js.clientWidth = svgElm_js.style.width
            document.getElementById("videos").style.maxHeight = svgElm_js.style.height + "px"
            console.log(document.getElementById("videos"));
            var svgElm_js_height = svgElm_js.clientHeight
            var svgElm_js_width = svgElm_js.clientWidth
            var init_viewBox = "0 0 " + String(svgElm_js_width) + " " + String(svgElm_js_height)
            svgElm_js.setAttribute("viewBox", init_viewBox)
            function resizeWindow(e) {
                svgElm_js.clientHeight = svgElm_js.style.height
                svgElm_js.clientWidth = svgElm_js.style.width
                var svgElm_js_height = svgElm_js.clientHeight
                var svgElm_js_width = svgElm_js.clientWidth
                document.getElementById("videos").style.maxHeight = svgElm_js.clientHeight + "px"
                console.log(document.getElementById("videos").style.maxHeight);
                var [minX, minY, width, height] = svgElm_js.getAttribute('viewBox').split(' ')
                            .map(s => parseFloat(s));
                var init_viewBox = String(minX) + " " + String(minY) + " " + String(svgElm_js_width) + " " + String(svgElm_js_height)

                svgElm_js.setAttribute("viewBox", init_viewBox)
            }
            window.onresize = resizeWindow;

            function getViewBox() {
                var [minX, minY, width, height] = svgElm_js.getAttribute('viewBox')
                    .split(' ')
                    .map(s => parseFloat(s));
                return [minX, minY, width, height]
            }

            var wheel_event = 'ontouchstart' in window ? "touchmove" : "wheel";
            var baseDistance = 0

            function zoomAction() {
                
                document.getElementById("drawingCanvas").addEventListener(wheel_event, function(e) {
                    if (pointerType == "zoom_in" || pointerType == "zoom_out" ) {
                        var scale = 1
                        e.preventDefault()
                        var pointer_x = 0
                        var pointer_y = 0
                        if (wheel_event == "touchmove") {
                            var touches = e.changedTouches ;
                            if (touches.length > 1) {
                                try {
                                    var page_x1 = touches[0].pageX;
                                    var page_y1 = touches[0].pageY;

                                    // 座標2 (2本目の指)
                                    var page_x2 = touches[1].pageX
                                    var page_y2 = touches[1].pageY

                                    var x1 = getPositionXOnSvgByX(touches[0].pageX);
                                    var y1 = getPositionYOnSvgByY(touches[0].pageY);

                                    // 座標2 (2本目の指)
                                    var x2 = getPositionXOnSvgByX(touches[1].pageX);
                                    var y2 = getPositionYOnSvgByY(touches[1].pageY);

                                    // 2点間の距離
                                    var distance = Math.sqrt(Math.pow(page_x2 - page_x1, 2) + Math.pow(page_y2 - page_y1, 2));
                                    if (baseDistance != 0) {
                                        scale = baseDistance / distance;
                                    }
                                    pointer_x = (x1 + x2)/2;
                                    pointer_y = (y1 + y2)/2;
                                    baseDistance = distance
                                } catch (error) {
                                    console.error(error);
                                }
                    
                            }
                        } else {
                            var dy = e.deltaY
                            scale = dy < 0 ? 0.99 : 1.01
                            pointer_x = getPositionXOnSvg(e)
                            pointer_y = getPositionYOnSvg(e)
                        }
                        console.log(scale);
                        var [a, b, w, h] = svgElm_js.getAttribute('viewBox')
                            .split(' ')
                            .map(s => parseFloat(s));
                        var a_ = (a - pointer_x)*scale + pointer_x;
                        var b_ = (b - pointer_y)*scale + pointer_y;
                        var h_ = h*scale;
                        var w_ = w*scale;
                        const zoomedViewBox = [a_, b_, w_, h_].join(' ');
                        svgElm_js.setAttribute('viewBox', zoomedViewBox);

                    }
                }, {passive: false})
            }
            zoomAction()

            function zoomActionOnPad() {
                document.getElementById("drawingCanvas").addEventListener("touchend", function(e) {
                    if (pointerType == "zoom_in" || pointerType == "zoom_out" ) {
                        if (wheel_event == "touchmove") {
                            baseDistance = 0
                        }
                    }
                })
            }

            zoomActionOnPad()

            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }
            const roomName = JSON.parse(document.getElementById('token').textContent);

            
            

            var ws_or_wss;
            if (location.protocol == 'http:') {
                ws_or_wss = 'ws://'
            } else if (location.protocol == 'https:') {
                ws_or_wss = 'wss://'
            }

            roomSocket = new WebSocket(
                ws_or_wss
                + window.location.host
                + '/ws/rooms/'
                + roomName
                + '/'
            );

            function defultDraw(data) {
                Object.keys(data.data).forEach(function(key) {
                    //初期データをjsonfileに書き込む用のデータに加える
                    drawingData[key] = this[key];
                    var value = this[key];
                    var draw_type = value.type
                    switch (draw_type) {
                        case "draw":
                            var pathElm = document.createElementNS("http://www.w3.org/2000/svg", "path");
                            svgElm.append(pathElm);
                            console.log(value);
                            svgElm.find("path:last").attr({
                                "id": key,
                                "d": value.d, 
                                "fill": "none",
                                "stroke": value.stroke, 
                                "stroke-width": value.strokeSize, 
                                "stroke-linecap": "round" 
                            });
                            var transform = pathElm.transform.baseVal.createSVGTransformFromMatrix(SVGMatrixCreate())
                            if (!pathElm.hasAttribute("transform")) {
                                pathElm.transform.baseVal.appendItem(transform);
                            }

                            // var Matrix = target.transform.matrix;
                            var Matrix = pathElm.transform.baseVal[0].matrix;
                            Matrix.e = value.x;
                            Matrix.f = value.y;
                            break;
                        case "image":
                            var imageElm = document.createElementNS("http://www.w3.org/2000/svg", "image");
                            imageElm.setAttribute("href", value.href);
                            imageElm.setAttribute("id", value.id);
                            imageElm.setAttribute("width", value.width);
                            imageElm.setAttribute("height", value.height);
                            imageElm.setAttribute("x", value.cx);
                            imageElm.setAttribute("y", value.cy);
                            svgElm.append(imageElm);
                            var transform = imageElm.transform.baseVal.createSVGTransformFromMatrix(SVGMatrixCreate())
                            if (!imageElm.hasAttribute("transform")) {
                                imageElm.transform.baseVal.appendItem(transform);
                            }

                            // var Matrix = target.transform.matrix;
                            var Matrix = imageElm.transform.baseVal[0].matrix;
                            Matrix.e = value.x;
                            Matrix.f = value.y;
                            break;
                        case "textBox":
                            createTextBox(value.cx, value.cy, value.x, value.y, value.id, value.text);
                            break;
                        case "":
                            svgElm.html("");
                            break;
                        default:
                            console.log("no type");
                    }
            }, data.data)
        }
            function loadRoom() {
                const apiUrl =
                    '/rooms/api/'
                    + roomName
                    + '/load'
                loadingData = ajax("dummy", apiUrl, "GET", defultDraw)
            }

            loadRoom()

            roomSocket.onclose = function (e) {
                console.error('socket closed unexpectedly');
            };

            var user_name = JSON.parse(document.getElementById('user_name').textContent);
            var pc_list = {};
            var dataChannelList = {};
            var remoteStream;
            var localStream;
            var dummy_stream = new MediaStream();
            var dummy_track = new MediaStream();
            var videoRoomSocket;
            let pc_config = {
                "iceServers": [
                    { "urls": "stun:stun.l.google.com:19302" }
                ]
            };

            var visibility = document.getElementById("visibility_" + user_name)
            visibility.addEventListener("click", function() {
                    console.log("click");
                    document.getElementById("localVideo").style.display = "none"
                    document.getElementById("name_" + user_name).style.display = "none"
                    document.getElementById("visibility_" + user_name).style.display = "none"
                    document.getElementById("mic").style.display = "none"
                    document.getElementById("switch_video").style.display = "none"
                    document.getElementById("invisible_" + user_name).style.display = ""
                })
                var invisibility = document.getElementById("invisible_" + user_name)
                invisibility.addEventListener("click", function() {
                    console.log("click");
                    document.getElementById("localVideo").style.display = ""
                    document.getElementById("name_" + user_name).style.display = ""
                    document.getElementById("visibility_" + user_name).style.display = ""
                    document.getElementById("mic").style.display = ""
                    document.getElementById("switch_video").style.display = ""
                    document.getElementById("invisible_" + user_name).style.display = "none"
                })

            async function startInOrder() {
                let stream = null;

                try {
                    stream = await navigator.mediaDevices.getUserMedia({audio: true, video: true});
                    await gotStream(stream);
                    videoRoomSocket = await new WebSocket(
                        ws_or_wss
                        + window.location.host
                        + '/ws/webrtc/'
                        + roomName
                        + '/'
                    );
                    await startConnection();
                    await setMessage();
                } catch(e) {
                    console.log('startInOrder() error: ' + e.message);
                }
            }
            startInOrder();

            window.onbeforeunload = function (event) {
                videoRoomSocket.send(JSON.stringify({
                    "type": "bye",
                    "from": user_name,
                    "to": "all"
                }));
            }

            async function gotStream(stream) {
                console.log('Adding local stream.');
                var audio_track = stream.getAudioTracks()[0];
                audio_track.enabled = false;
                localStream = stream;
                localVideo.srcObject = stream;
            }

            async function startConnection() {
                videoRoomSocket.onopen = async function (e) {
                console.log('video room socket opened successfully')
                await videoRoomSocket.send(JSON.stringify({
                    "type": "join",
                    "user_name": user_name
                }))
                videoRoomSocket.onclose = async function (e) {
                console.error('video room socket closed unexpectedly');
            };
            }
            }

            function switchVideo() {
                var btn = document.getElementById("switch_video");
                btn.addEventListener("click", function() {
                    var mediaStream = localVideo.srcObject.getTracks();
                    for (var i = 0; i < mediaStream.length; i++) {
                        if (mediaStream[i].kind === "video") {
                            if (mediaStream[i].enabled) {
                                mediaStream[i].enabled = false;
                                btn.innerHTML= `<i class="material-icons">videocam_off</i>`
                            } else {
                                mediaStream[i].enabled = true;
                                btn.innerHTML= `<i class="material-icons">videocam</i>`
                            }
                        }
                    }
                } )
            }

            switchVideo()

            function switchAudio() {
                var btn = document.getElementById("mic");
                btn.addEventListener("click", function() {
                    var mediaStream = localVideo.srcObject.getTracks();
                    for (var i = 0; i < mediaStream.length; i++) {
                        if (mediaStream[i].kind === "audio") {
                            if (mediaStream[i].enabled) {
                                mediaStream[i].enabled = false;
                                btn.innerHTML= `<i class="material-icons">mic_off</i>`
                            } else {
                                mediaStream[i].enabled = true;
                                btn.innerHTML= `<i class="material-icons">mic</i>`
                            }
                        }
                    }
                } )
            }

            switchAudio()

            async function setMessage() {
                videoRoomSocket.onmessage = function (e) {
             const data = JSON.parse(e.data);
             if (data.type === 'bye') {
                 if (data.from !== user_name) {
                     stop(data.from);
                 }
                 return;
             }
             if (data.message == "join") {
                 console.log("join?");
                 if (data.user_name !== user_name) {
                    console.log("join!");
                     videoRoomSocket.send(JSON.stringify({
                         "type": "hello",
                         "to": data.user_name,
                         "from": user_name
                     }));
                     return;
                 }
                 return
             }
             if (data.message == "hello") {
                 if (data.to == user_name) {
                     createPeerConnection(data.from);
                     doCall(data.from, data.to, pc_list[data.from]);
                     console.log("start from: ", user_name);
                 } else {
                     if (data.from == user_name) {
                         createPeerConnection(data.to);
                         recieveDataChannel(pc_list[data.to], data.to)
                         console.log("recieve: ", user_name);
                     }
                 }
                 return
             }
             
             if (data.message.type === 'offer') {
                 console.log("offer data: ", data);
                 if (data.to == user_name) {
                     console.log('remote description', data.message);
                     pc_list[data.from].setRemoteDescription(new RTCSessionDescription(data.message));
                     doAnswer(data.from, data.to, pc_list[data.from]);
                 }
             } else if (data.message.type === 'answer') {
                 if (data.to == user_name) {
                     console.log("recieved answer");
                     pc_list[data.from].setRemoteDescription(new RTCSessionDescription(data.message));
                 }
             } else if (data.message.type === 'candidate') {
                 if (data.to === user_name || data.from === user_name) {
                     var name = data.to === user_name ? data.from : data.to;
                     if (pc_list[name] !== data.message.target) {
                         console.log("candidate", data.message.candidate);
                         var candidate = new RTCIceCandidate({
                             sdpMLineIndex: data.message.label,
                             candidate: data.message.candidate
                         });
                         pc.addIceCandidate(candidate);
                     }
                 }
             }
         };
            }

         function recieveDataChannel(pc, name) {
             pc.ondatachannel = function (event) {
                 console.log('ondatachannel:', event.channel);
                 dataChannelList[name] = event.channel;
                 onDataChannelCreated(dataChannelList[name]);
             };
         }

         function createPeerConnection(name) {
             try {
                 pc = new RTCPeerConnection(pc_config);
                 pc.addEventListener('track', function (event) {
                     console.log("remote stream: ", event.streams[0].getTracks());
                     if (event.track.kind === "video") {

                        handleRemoteStreamAdded(event.streams[0], name);
                     }
                 })

                 pc.addEventListener('isolationchange', function (event) {
                     console.log(event);
                 })
                 pc.addEventListener('icecandidate', function (event) {
                     console.log('icecandidate event: ', event);
                     if (event.candidate) {
                         sendMessage({
                             type: 'candidate',
                             label: event.candidate.sdpMLineIndex,
                             id: event.candidate.sdpMid,
                             candidate: event.candidate.candidate,
                             target: event.target,
                         },
                             name,
                             user_name
                         );
                     } else {
                         console.log('End of candidates.');
                     }
                 })
                 pc.addEventListener('iceconnectionstatechange', () => {
                     pc.iceConnectionState;
                     if (pc.iceConnectionState == "disconnected" || pc.iceConnectionState == "failed") {
                         console.log(`${name} connection: `, pc.iceConnectionState);
                         logOnView(`${getUserNameByToken(name)} との接続が切れました`, 4000, "orange")
                         delete dataChannelList[name]
                         stop(name);
                     }
                     console.log(`${name} connection: `, pc.iceConnectionState);
                 });
                 console.log('signalingstate: ', pc.signalingState);
                 pc.addEventListener('signalingstatechange', () => {
                     console.log('signalingstate: ', pc.signalingState);
                     signalingState = pc.signalingState;
                 });
                 pc_list[name] = pc;
                 var video_track = localStream.getVideoTracks()[0];
                 var audio_track = localStream.getAudioTracks()[0];
                 console.log("local stream: ", localStream.getTracks());
                 pc.addTrack(video_track, localStream);
                 pc.addTrack(audio_track, localStream);
                 console.log('Created RTCPeerConnnection');
             } catch (e) {
                 console.log('Failed to create PeerConnection, exception: ' + e.message);
                 logOnView(`接続できません。: ${e.message}`, 10000, "red")
                 return;
             }
         }

         function getUserNameByToken(token) {
             username = "匿名"
             for (var i = 0; i < user_list.length; i++) {
                 if (user_list[i].token == token) {
                     username = user_list[i].username
                     break;
                 }
             }

             return username
         }

         function doCall(to, from, pc) {
             console.log('Sending offer to peer');
             dataChannelList[to] = pc.createDataChannel('test');
             console.log("create dataChannel");
             onDataChannelCreated(dataChannelList[to]);
             pc.createOffer().then(function (sessionDescription) {
                 pc.setLocalDescription(sessionDescription);
                 sendMessage(sessionDescription, to, from);
                 return;
             });
         }

         function handleRemoteStreamAdded(stream, name) {
                console.log('Remote stream added.');
                console.log('stream: ', stream.getTracks());
                remoteVideo = document.createElement("video");
                remoteVideo.autoplay = true;
                remoteVideo.playsinline = true;
                remoteVideo.muted = false;
                remoteVideo.setAttribute("id", name)
                remoteVideo.setAttribute("class", "z-depth-5")
                remoteVideoDiv = document.createElement("div");
                remoteVideoDiv.setAttribute("id", name + "_box")
                remoteVideoDiv.style.position = "relative"
                remoteVideoName = document.createElement("div");
                remoteVideoName.setAttribute("id", "name_" + name)
                remoteVideoName.style.position = "absolute"
                remoteVideoName.style.bottom = "5px"
                remoteVideoName.style.left = "0px"
                remoteVideoName.style.backgroundColor = "black"
                remoteVideoName.style.color = "white"
                remoteVideoVisibleDiv = document.createElement("div");
                remoteVideoVisibleDiv.setAttribute("id", "visible_" + name)
                remoteVideoVisibleDiv.style.position = "absolute"
                remoteVideoVisibleDiv.style.bottom = "0px"
                remoteVideoVisibleDiv.style.right = "0px"
                remoteVideoVisibleDiv.innerHTML = `<span class='' href='#' id="visibility_${name}" style="color: white" class="visible"><i class="material-icons">visibility_off</i></span>`
                remoteVideoInvisibleDiv = document.createElement("div");
                remoteVideoInvisibleDiv.setAttribute("id", "invisible_" + name)
                remoteVideoInvisibleDiv.style.position = "relative"
                remoteVideoInvisibleDiv.style.top = "10px"
                remoteVideoInvisibleDiv.style.left = "10px"
                remoteVideoInvisibleDiv.style.margin = "10px"
                remoteVideoInvisibleDiv.style.display = "none"
                remoteVideoInvisibleDiv.innerHTML = `<span class='tooltipped' id="person_${name}" data-position="right" data-delay="50" data-tooltip="" href='#' id="invisibility_${name}" style="color: white" class="visible"></span>`
                var videos = document.getElementById("videos");
                remoteVideoDiv.appendChild(remoteVideo)
                remoteVideoDiv.appendChild(remoteVideoName)
                remoteVideoDiv.appendChild(remoteVideoVisibleDiv)
                remoteVideoDiv.appendChild(remoteVideoInvisibleDiv)
                videos.appendChild(remoteVideoDiv);
                remoteVideo = document.getElementById(name);
                remoteStream = stream;
                remoteVideo.srcObject = remoteStream;
                remoteVideoVisibleDiv.addEventListener("click", function() {
                    console.log("click");
                    console.log(remoteVideoDiv.style.display);
                    document.getElementById(name).style.display = "none"
                    document.getElementById("name_" + name).style.display = "none"
                    document.getElementById("visible_" + name).style.display = "none"
                    document.getElementById("invisible_" + name).style.display = ""
                })
                remoteVideoInvisibleDiv.addEventListener("click", function() {
                    console.log("click");
                    console.log(remoteVideoDiv.style.display);
                    document.getElementById(name).style.display = ""
                    document.getElementById("name_" + name).style.display = ""
                    document.getElementById("visible_" + name).style.display = ""
                    document.getElementById("invisible_" + name).style.display = "none"
                })
                console.log(name);
                getUserName(name)
                
            }

         function onDataChannelCreated(channel) {
             console.log('onDataChannelCreated:', channel);

             channel.onopen = function () {
                 console.log('CHANNEL opened!!!');
                //  logOnView("CHANNEL opened!!!", 4000, "blue")
                 logOnView("ボードのデータが共有されました", 4000, "blue")
             };

             channel.onclose = function () {
                 console.log('Channel closed.');
                //  logOnView("Channel closed.", 4000, "red")
                 logOnView("接続が切れました", 4000, "red")
             }

             channel.onmessage = function(e) {
                 console.log('recieve message');
                 const data = JSON.parse(e.data);
                 console.log("data: ", data);
                var svgElm = $("#drawingCanvas")
                switch (data.type) {
                    case "draw":
                        var pathElm = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        var path_attr = {
                            "id": data.id,
                            "d": "", //pathデータ//塗りつぶし
                            "fill": "none",
                            "stroke": data.stroke, //線の色
                            "stroke-width": data.strokeSize, //線の太さ
                            "stroke-linecap": "round" //線の端を丸める
                        }
                        for (let key in path_attr) {
                            pathElm.setAttribute(key, path_attr[key])
                        }

                        svgElm.append(pathElm);
                        break;
                    case "drawing":
                        // svgElm.find("path:last").attr("d", data.d);
                        document.getElementById(data.id).setAttribute("d", data.d)
                        break;
                    case "delete":
                        var target = document.getElementById(data.id);
                        console.log(target);
                        target.remove();
                        break;
                    case "deleteAll":
                        svgElm_js.innerHTML = ""
                        drawingData = []
                    case "moveContent":
                        console.log(data.id);
                        var target = document.getElementById(data.id);
                        console.log(target);
                        var pathElm = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        var transform = pathElm.transform.baseVal.createSVGTransformFromMatrix(SVGMatrixCreate())
                        if (!target.hasAttribute("transform")) {
                            target.transform.baseVal.appendItem(transform);
                        }

                            // var Matrix = target.transform.matrix;
                        var Matrix = target.transform.baseVal[0].matrix;
                        Matrix.e += data.dx;
                        Matrix.f += data.dy;
                        break;
                    case "image":
                        createImage(data.cx, data.cy, data.x, data.y, data.width, data.height, data.href, data.id);
                        count = data.count;
                        break;
                    case "image_href":
                        href += data.href;
                        if (data.count === count) {
                            var target = document.getElementById(data.id);
                            target.setAttribute("href", href);
                            href = "";
                            count = 0;
                        }
                        break;
                    case "textBox":
                        createTextBox(data.cx, data.cy, data.x, data.y, data.id, data.text);
                        break;
                    case "writing":
                        document.getElementById(data.id).textContent = data.text;
                        break;
                    case "resize":
                        document.getElementById(data.id).width.baseVal.value += data.w;
                        document.getElementById(data.id).height.baseVal.value += data.h;
                        break;
                    case "shareData":
                        drawingData = data.data;
                        console.log("share");
                        break;
                    case "redo":
                        var target = document.getElementById(data.id)
                        target.remove()
                    default:
                        console.log("no data");
                        break;
                }
             }
         }

         function doAnswer(to, from, pc) {
             console.log('Sending answer to peer.');
             pc.createAnswer().then(function (sessionDescription) {
                 pc.setLocalDescription(sessionDescription);
                 sendMessage(sessionDescription, to, from);
                 return;
             });
         }

         function sendMessage(message, to, from) {
             console.log('Client sending message: ', message);
             var content = {
                 "type": "message",
                 "message": message,
                 "to": to,
                 "from": from,
             }
             videoRoomSocket.send(JSON.stringify(content));
         }

         function stop(name) {
             console.log(`Connection with ${name} was over`);
             document.getElementById(name).remove();
             document.getElementById(name + "_box").remove();
            //  remoteVideoDiv
             pc_list[name].close();
             delete pc_list[name];
         }

         var user_list = []

         function getUserName(token) {
             console.log(token);
            const apiUrl = '/myboard/api/user_info'
            var data = {
                token : token
            }
            console.log(data);
            var response = ajax(data, apiUrl, "POST", roomInComment)
         }

         function roomInComment(response) {
             console.log(response);
             var data = {"token": response.data.token, "username": response.data.username, "image": response.data.image_src}
             user_list.push(data)
             logOnView(response.data.username + "さんが入室しました。", 3000, "blue")
             var name_plate = document.getElementById("name_" + response.data.token)
             var name_tooltiped = document.getElementById("person_" + response.data.token)
             if (response.data.image_src != "") {
                document.getElementById("person_" + response.data.token).innerHTML = `<image src="${response.data.image_src}" height="30" width="30" class="circle" style="object-fit: cover;">`
             } else {
                document.getElementById("person_" + response.data.token).innerHTML = `<i class="material-icons circle black">person_outline</i>`
             }
             name_plate.textContent = response.data.username
         }



            function ajax(data, url, type, doneFunc) {
                var csrf_token = getCookie("csrftoken");
                var data = JSON.stringify(data);
                // var csrftoken1 = Cookies.get('csrftoken');
                var csrftoken2 = getCookie("csrftoken");
                var csrftoken3 = document.querySelector('[name=csrfmiddlewaretoken]').value;
                // console.log(`csrftoken1:${csrftoken1}`);
                console.log(`csrftoken2:${csrftoken2}`);
                console.log(`csrftoken3:${csrftoken3}`);
                $.ajax({
                    url: url,
                    type: type,
                    data: data,
                    beforeSend: function (xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrf_token);
                        }
                    },
                    dataType: 'json',
                    contentType: "application/json",
                }).done(function (response) {

                    if (data.error) {
                        console.log("ERROR");
                    }
                    else {
                        doneFunc(response);
                    }

                }).fail(function (xhr, status, error) {
                    console.log();
                    console.log(status + ":" + error + ":" + xhr);
                });
            }

            //色の取得
            function getColor() {
                let colors = document.getElementsByClassName("color");
                for (let i = 0; i < colors.length; i++) {
                    colors[i].addEventListener("click", () => {
                        strokeColor = colors[i].id
                        $("#color-btn").css("background-color", strokeColor)
                    }, false);
                }
            }

            getColor();

            function getStrokeSize() {
                let size = document.getElementsByClassName("size");
                for (let i = 0; i < size.length; i++) {
                    size[i].addEventListener("click", () => {
                        strokeSize = size[i].id
                        $("#draw").attr("data-tooltip", String(strokeSize) + "px")
                    }, false);
                }
            }

            getStrokeSize()

            var pointerType = "draw";

            //初期設定

            var svgElm = $("#drawingCanvas"), //SVG要素を取得
                svgElm_js = document.getElementById("drawingCanvas")
                board = $("#board"),
                movetoX = 0, //開始点(横方向)の初期化
                movetoY = 0, //開始点(縦方向)の初期化
                linetoStr = "", //LineToコマンド値の初期化
                strokeColor = "#666666", //描画色の初期化
                strokeSize = "3"
                drawType = ""; //塗りつぶしの初期化
            drawingData = {};
            browserDrawingData = {};
            svg_height = window.innerHeight;
            svg_width = window.innerWidth;
            browserDrawData = {};
            id = "";
            old_id = "";
            
            var input = document.createElement("input");
                input.id = "textToolInput";
                input.type = "text";
                input.setAttribute("autocomplete", "off");
            var text = "";
            var curText = "";

            var start_event = 'ontouchstart' in window ? "touchstart" : "mousedown";
            var move_event = 'ontouchstart' in window ? "touchmove" : "mousemove";
            var end_event = 'ontouchstart' in window ? "touchend" : "mouseup";
            var out_event = "mouseleave"

            function main() {
                $("#drawingCanvas").on(start_event, function (event) {
                    console.log("start");
                    event.preventDefault();
                    switch (pointerType) {
                        case "draw":
                            pencilByMousedown();
                            break;
                        case "moveScreen":
                            moveScreenByMousedown();
                            break;
                        case "moveContent": 
                            moveContentByMousedown();
                            break;
                        case "eraser": 
                            eraserByMousedown();
                            break;
                        case "text": 
                            textBoxMousedown();
                            break;
                        default:
                            console.log("main");
                            break;
                    }
                }).on(end_event, function (event) {
                    event.preventDefault();
                    console.log("end");
                    switch (pointerType) {
                        case "draw":
                            pencilByMouseup();
                            break;
                        case "moveScreen":
                            moveScreenByMouseup();
                            break;
                        case "moveContent": 
                            moveContentByMouseup();
                            break;
                        case "eraser": 
                            eraserByMouseup();
                            break;
                        case "text": 
                            textBoxMouseup();
                            break;
                        default:
                            console.log("main");
                            break;
                    }
                })
            }

            main();


            function mainOnSmartphone() {

            }

            function changePinterType() {
                let pointerTypeClass = document.getElementsByClassName("pointer-type");
                for (let i = 0; i < pointerTypeClass.length; i++) {
                    pointerTypeClass[i].addEventListener("click", () => {
                        if (pointerTypeClass[i].classList.contains("button")) {
                            return
                        }
                        if (document.querySelectorAll(".catch")) {
                            var rects = document.querySelectorAll(".catch");
                            for (var j = 0; j < rects.length; j++) {
                                rects[j].remove();
                            }
                        }
                        pointerType = pointerTypeClass[i].id;
                        if (pointerTypeClass[i].classList.contains("controller")) {
                            // pointerTypeClass[i].style.backgroundColor = "#bbdefb";
                            pointerTypeClass[i].classList.add("blue-text")
                        } else {
                            pointerTypeClass[i].style.backgroundColor = "#2962ff";
                        }
                        
                        for (let j = 0; j < pointerTypeClass.length; j++) {
                            if (j !== i) {
                                if (pointerTypeClass[j].classList.contains("controller")) {
                                    // pointerTypeClass[i].style.backgroundColor = "#bbdefb";
                                    pointerTypeClass[j].classList.remove("blue-text")
                                    // pointerTypeClass[i].classList.add("blue-text")
                                } else {
                                    pointerTypeClass[j].style.backgroundColor = "#42a5f5";
                                }
                                
                            }
                        }
                        console.log(`change:${pointerType}`);
                    }, false);
                }
            }

            changePinterType();
            var onDown = false;

            function moveScreenByMousedown() {
                // $("body").on(start_event, function (event) {
                event.preventDefault();
                svgElm.css("cursor", "move")
                onDown = true;
                var mouse_move_x = parseFloat(getPageX(event)); //SVG上のマウス座標(横方向)の取得
                    mouse_move_y = parseFloat(getPageY(event)); //SVG上のマウス座標(縦方向)の取得
                $("#drawingCanvas").on(move_event, function (event) {
                    if (!onDown) return;
                    
                    
                    event.preventDefault();
                    // event.stopPropagation();
                    // var mouse_moving_x = parseFloat(getPositionXOnSvg(event)); //SVG上のマウス座標(横方向)の取得
                    // var mouse_moving_y = parseFloat(getPositionYOnSvg(event)); //SVG上のマウス座標(縦方向)の取得
                    // if (mouse_moving_x == mouse_move_x || mouse_moving_y == mouse_move_y) return
                    var mouse_moving_x = parseFloat(getPageX(event));
                    var mouse_moving_y = parseFloat(getPageY(event));
                    
                    const viewBoxList = svgElm_js.getAttribute('viewBox').split(' ');
                    var svg_w = svgElm_js.clientWidth
                    var pageX_aspect =  viewBoxList[2]/svg_w
                    var x_length = (mouse_moving_x - mouse_move_x)*pageX_aspect;
                    var y_length = (mouse_moving_y - mouse_move_y)*pageX_aspect;
                    
                    mouse_move_x = mouse_moving_x;
                    mouse_move_y = mouse_moving_y;

                    viewBoxList[0] = '' + (parseFloat(viewBoxList[0]) - x_length);
                    viewBoxList[1] = '' + (parseFloat(viewBoxList[1]) - y_length);
                    const viewBox = viewBoxList.join(' ');
                    // if (old_length_x == x_length*(-1) && old_length_y == y_length*(-1)) return;
                    
                    svgElm_js.setAttribute('viewBox', viewBox);

                });
            // });
            }
            // moveScreenByMousedown()

            function moveScreenByMouseup() {
                console.log("finish");
                onDown = false;
                
                svgElm.css("cursor", "default")
                $("#drawingCanvas").off(move_event);
            }

            function SVGMatrixCreate(a, b, c, d, e, f) {
                var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                var mtx = svg.createSVGMatrix();
                if (a !== undefined) mtx.a = a;
                if (b !== undefined) mtx.b = b;
                if (c !== undefined) mtx.c = c;
                if (d !== undefined) mtx.d = d;
                if (e !== undefined) mtx.e = e;
                if (f !== undefined) mtx.f = f;
                return mtx;
            }

            var selected_elm = document.elementFromPoint(0, 0);

            function moveContentByMousedown() {
                var target = document.elementFromPoint(getPageX(event), getPageY(event));
                id = target.id;
                svgElm.css("cursor", "grab")
                var mouse_move_x = 0;
                mouse_move_y = 0;
                mouse_move_x = parseInt(getPositionXOnSvg(event)); //SVG上のマウス座標(横方向)の取得
                mouse_move_y = parseInt(getPositionYOnSvg(event)); //SVG上のマウス座標(縦方向)の取得
                var dx = 0;
                dy = 0;
                // var Matrix = target.target.parentNode.createSVGTransform();
                var transform = target.transform.baseVal.createSVGTransformFromMatrix(SVGMatrixCreate())
                if (!target.hasAttribute("transform")) {
                    target.transform.baseVal.appendItem(transform);
                }

                // var Matrix = target.transform.matrix;
                var Matrix = target.transform.baseVal[0].matrix;
                if (target !== document.getElementById("drawingCanvas") && !target.classList.contains('catch')) {
                    old_id = id
                    if (document.querySelectorAll(".catch")) {
                        var rects = document.querySelectorAll(".catch");
                        for (var i = 0; i < rects.length; i++) {
                            rects[i].remove();
                        }
                    }
                    selected_elm = target;
                    var box = target.getBBox();
                    var x = box.x + Matrix.e - 1.5;
                    var y = box.y + Matrix.f - 1.5;
                    var h = box.height + 3;
                    var w = box.width + 3;
                    createRect(x, y, w, h, svgElm, "elm_rect", "none", "#42a5f5", 1);
                    createRect(x + w - 5, y + h - 5, 10, 10, svgElm, "mini_rect", "#42a5f5", 'white', 2);
                }
                var elm_rect = document.querySelector("#elm_rect");
                var mini_rect = document.querySelector("#mini_rect");
                elm_rect.transform.baseVal.appendItem(transform);
                mini_rect.transform.baseVal.appendItem(transform);
                var elm_rect_matrix = elm_rect.transform.baseVal[0].matrix;
                var mini_rect_matrix = mini_rect.transform.baseVal[0].matrix;
                var rects = document.querySelectorAll(".catch");
                for (var i = 0; i < rects.length; i++) {
                    rects[i].transform.baseVal.appendItem(transform);
                }
                $("#drawingCanvas").on(move_event, function (event) {
                    if (target !== document.getElementById("drawingCanvas") && !target.classList.contains('catch')) {
                        svgElm.css('cursor', 'grabbing');
                        var mouse_moving_x = parseInt(getPositionXOnSvg(event)); //SVG上のマウス座標(横方向)の取得
                        var mouse_moving_y = parseInt(getPositionYOnSvg(event)); //SVG上のマウス座標(縦方向)の取得
                        var x_length = mouse_moving_x - mouse_move_x;
                        var y_length = mouse_moving_y - mouse_move_y;
                        mouse_move_x = mouse_moving_x;
                        mouse_move_y = mouse_moving_y;
                        var sendData = {
                            "type": "moveContent",
                            "id": id,
                            "dx": x_length,
                            "dy": y_length
                        }
                        // roomSocket.send(JSON.stringify(sendData));
                        sendOnDatachannel(sendData);

                        var pathElm = document.createElementNS("http://www.w3.org/2000/svg", "path");

                        var targetContent = document.getElementById(sendData.id);
                        var transform = pathElm.transform.baseVal.createSVGTransformFromMatrix(SVGMatrixCreate())
                        if (!targetContent.hasAttribute("transform")) {
                            targetContent.transform.baseVal.appendItem(transform);
                        }

                            // var Matrix = targetContent.transform.matrix;
                        var Matrix = targetContent.transform.baseVal[0].matrix;
                        Matrix.e += sendData.dx;
                        Matrix.f += sendData.dy;

                        for (var i = 0; i < rects.length; i++) {
                            rects[i].transform.baseVal[0].matrix.e += x_length
                            rects[i].transform.baseVal[0].matrix.f += y_length
                        }
                        drawingData[targetContent.id].x = targetContent.transform.baseVal[0].matrix.e;
                        drawingData[targetContent.id].y = targetContent.transform.baseVal[0].matrix.f;
                    }
                    if (target.classList.contains('catch')) {
                        var resizeData = {};
                        var aspect = selected_elm.width.baseVal.value / selected_elm.height.baseVal.value
                        var mouse_moving_x = parseInt(getPositionXOnSvg(event)); //SVG上のマウス座標(横方向)の取得
                        var mouse_moving_y = parseInt(getPositionYOnSvg(event));
                        var x_length = mouse_moving_x - mouse_move_x;
                        var y_length = mouse_moving_y - mouse_move_y;
                        mouse_move_x = mouse_moving_x;
                        mouse_move_y = mouse_moving_y;
                        var length_aspect = x_length / y_length;
                        var w = 0;
                        var h = 0;
                        if (length_aspect < aspect) {
                            w = y_length * aspect;
                            h = y_length;
                        } else {
                            w = x_length;
                            h = x_length / aspect;
                        }
                        resizeData = {
                            "type": "resize",
                            "id": old_id,
                            "w": w,
                            "h": h
                        }
                        // roomSocket.send(JSON.stringify(resizeData));
                        sendOnDatachannel(resizeData);
                        document.getElementById(resizeData.id).width.baseVal.value += resizeData.w;
                        document.getElementById(resizeData.id).height.baseVal.value += resizeData.h;
                        elm_rect.width.baseVal.value += w;
                        elm_rect.height.baseVal.value += h;
                        mini_rect.x.baseVal.value += w;
                        mini_rect.y.baseVal.value += h;
                        drawingData[resizeData.id].width = document.getElementById(resizeData.id).width.baseVal.value;
                        drawingData[resizeData.id].height = document.getElementById(resizeData.id).height.baseVal.value;
                    }
                    $("#drawingCanvas").on(out_event, function (event) {
                        moveContentByMouseup()
                    })
                });
            }

            function moveContentByMouseup() {
                saveBoardData();
                console.log("save");
                svgElm.css('cursor', 'default');
                $("#drawingCanvas").off(move_event);
                $("#drawingCanvas").off(out_event);
            }

            function eraserByMousedown() {
                        $("#drawingCanvas").on(move_event, function (evt) {
                            // event.preventDefault()
                            var target = document.elementFromPoint(getPageX(evt), getPageY(evt));
                            var target_id = target.id;
                            if (target !== document.getElementById("drawingCanvas") && target_id !== "") {
                                var target_id = target.id;
                                var sendData = {
                                    "type" : "delete",
                                    "id" : target_id
                            }
                            // roomSocket.send(JSON.stringify(sendData));
                            sendOnDatachannel(sendData);
                            var target = document.getElementById(sendData.id);
                            target.remove();
                            delete drawingData[target_id];
                            }
                        });
            }

            function eraserByMouseup() {
                $("#drawingCanvas").off(move_event);
                saveBoardData();
            }

            var curText = "";

            function textBoxMousedown() {
                console.log("textBox");
            }

            function textBoxMouseup() {
                var sendTextData = {};
                var sendTextBoxData = {};
                var input_x = parseInt(getPageX(event));
                var input_y = parseInt(getPageY(event));
                document.getElementById('board').appendChild(input);
                input.value = "";
                input.style.left = input_x + 'px';
                input.style.top = input_y + 'px';
                input.style.position = 'fixed';
                input.focus();
                id = Math.random().toString(32).substring(2);
                var x = parseInt(getPositionXOnSvg(event));
                var y = parseInt(getPositionYOnSvg(event));
                createTextBox(x, y, 0, 0, id, text);
                sendTextBoxData.cx = x;
                sendTextBoxData.cy = y;
                sendTextBoxData.x = 0;
                sendTextBoxData.y = 0;
                sendTextBoxData.id = id;
                sendTextBoxData.text = text;
                sendTextBoxData.type = "textBox"
                drawingData[id] = sendTextBoxData;
                saveBoardData();
                // roomSocket.send(JSON.stringify(sendTextBoxData));
                sendOnDatachannel(sendTextBoxData);
                createTextBox(sendTextBoxData.cx, sendTextBoxData.cy, sendTextBoxData.x, sendTextBoxData.y, sendTextBoxData.id, sendTextBoxData.text);

                input.addEventListener("keyup", function () {
                    if (curText !== this.value) {
                        drawingData[id].text = this.value;
                        sendTextData = {
                            "type": "writing",
                            "id": id,
                            "text": input.value
                        }
                        // roomSocket.send(JSON.stringify(sendTextData));
                        sendOnDatachannel(sendTextData);
                        document.getElementById(sendTextData.id).textContent = sendTextData.text;
                        curText = input.value;
                        saveBoardData();
                    }
                })
                input.addEventListener("blur", function () {
                    input.removeEventListener("keyup", function () { })
                    input.style.top = '-1000px';
                })
                input.addEventListener("blur", function () {
                    input.removeEventListener("keyup", function () { })
                    input.style.top = '-1000px';
                })
                input.addEventListener("keypress", function (e) {
                    if (e.keyCode === 13) {
                        input_y += 20
                        input.style.top = input_y + 'px';
                        id = Math.random().toString(32).substring(2);
                        y += 20;
                        createTextBox(x, y, 0, 0, id, text);
                        sendTextBoxData.cx = x;
                        sendTextBoxData.cy = y;
                        sendTextBoxData.x = 0;
                        sendTextBoxData.y = 0;
                        sendTextBoxData.id = id;
                        sendTextBoxData.text = text;
                        sendTextBoxData.type = "textBox"
                        drawingData[id] = sendTextBoxData;
                        saveBoardData();
                        createTextBox(sendTextBoxData.cx, sendTextBoxData.cy, sendTextBoxData.x, sendTextBoxData.y, sendTextBoxData.id, sendTextBoxData.text);
                        sendOnDatachannel(sendTextBoxData);
                        input.value = ""
                    }
                })
            }

            function svgResize() {
                window.addEventListener('scroll', () => {
                    const allHeight = Math.max(
                        document.body.scrollHeight, document.documentElement.scrollHeight,
                        document.body.offsetHeight, document.documentElement.offsetHeight,
                        document.body.clientHeight, document.documentElement.clientHeight
                    );
                    const mostBottom = allHeight - window.innerHeight;
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    if (scrollTop >= mostBottom) {
                        var next_height = Number(svgElm.attr("height")) + 50
                        svgElm.attr("height", `${next_height}`);
                    }
                });
            }
            // function initSvgSize() {
            //     var init_height = String(window.innerHeight - 10) + "px";
            //     var init_width = String(window.innerWidth - 10 - 100) + "px";
            //     // svgElm.attr("height", `2000`);
            //     // svgElm.attr("width", `2000`);
            //     console.log(board[0]);
            //     board[0].css("height", init_height)
            //     board[0].css("width", init_width)
            //     board[0].css("overflow", "auto")
            // }
            // initSvgSize()

            svgResize();

            function pencilByMousedown() {
                movetoX = parseInt(getPositionXOnSvg(event));
                movetoY = parseInt(getPositionYOnSvg(event));

                id = Math.random().toString(32).substring(2);

                browserDrawData = {
                    "id": id,
                    'type': "draw",
                    "d": "",
                    "fill": "none",
                    "stroke": strokeColor,
                    "strokeSize": strokeSize,
                    "stroke-linecap": "round",
                    "x": 0,
                    "y": 0
                }

                // roomSocket.send(JSON.stringify(browserDrawData));
                sendOnDatachannel(browserDrawData);
                var pathElm = document.createElementNS("http://www.w3.org/2000/svg", "path");
                var path_attr = {
                    "id": browserDrawData.id,
                    "d": "", //pathデータ//塗りつぶし
                    "fill": "none",
                    "stroke": browserDrawData.stroke, //線の色
                    "stroke-width": strokeSize, //線の太さ
                    "stroke-linecap": "round" //線の端を丸める
                }
                for (let key in path_attr) {
                    pathElm.setAttribute(key, path_attr[key])
                }
                
                svgElm.append(pathElm);


                var linetoX = [], //描画点の横座標の初期化
                    linetoY = [], //描画点の縦座標の初期化
                    cntMoveto = 0; //描画点のカウンターを初期化
                linetoStr = 'M ' + movetoX + ' ' + movetoY + ' '; //d要素でpathの開始点を設定

                /* ドラッグ中 */
                $("#drawingCanvas").on(move_event, function (event) {
                    event.preventDefault();
                    linetoX[cntMoveto] = parseInt(getPositionXOnSvg(event)); //SVG上のマウス座標(横方向)の取得
                    linetoY[cntMoveto] = parseInt(getPositionYOnSvg(event)); //SVG上のマウス座標(縦方向)の取得
                    linetoStr = linetoStr + " L " + linetoX[cntMoveto] + " " + linetoY[cntMoveto]; //動いた後の新たなマウス座標を描画点として追加

                    // svgElm.find("path:last").attr("d", linetoStr); //pathデータ(d属性)の値を更新
                    browserDrawingData = {
                        'id': pathElm.id,
                        'type': "drawing",
                        "d": linetoStr
                    }

                    // roomSocket.send(JSON.stringify(browserDrawingData));
                    sendOnDatachannel(browserDrawingData);
                    pathElm.setAttribute("d", browserDrawingData.d);
                    cntMoveto++; //カウンターをセット
                    $("#drawingCanvas").on(out_event, function (event) {
                        console.log("mouseup");
                        pencilByMouseup()
                    })
                });
            }

            function pencilByMouseup() {
                browserDrawData["d"] = linetoStr
                drawingData[id] = browserDrawData;
                $("#drawingCanvas").off(move_event); //pathの描画を終了
                $("#drawingCanvas").off(out_event);
                saveBoardData();
            }

            function saveBoardData() {
                const apiUrl =
                        '/rooms/api/'
                        + roomName
                        + '/update/'
                    const afterDrawFunc = function (response) {
                        logOnView(response.message, 1000, "blue")
                        return response;
                    }
                    console.log(drawingData);
                    ajax(drawingData, apiUrl, "post", afterDrawFunc)
                    shareBoardData();
            }

            function shareBoardData() {
                var boardDataToShare = {
                    "type" : "shareData",
                    "data" : drawingData
                };
                // sendOnDatachannel(boardDataToShare);
                // shareは容量の問題があるので、socket使う
                roomSocket.send(JSON.stringify(boardDataToShare));
                drawingData = boardDataToShare.data;
            }

            var count;
            var href = ""

            function eraserAll() {
                document.getElementById("eraserAll").addEventListener("click", function() {
                    if (confirm("ボード内容を全て削除しますか？")) {
                        // for (let id in drawingData) {
                        //     var target = document.getElementById(id)
                        //     target.remove()
                        // }
                        svgElm_js.innerHTML = ""
                        var sendData = {
                                        "type" : "deleteAll",
                                    }
                        drawingData = {}
                        sendOnDatachannel(sendData);
                        saveBoardData();
                    }
                })
            }
            eraserAll()

            function redo() {
                document.getElementById("redo").addEventListener("click", function() {
                        var target = svgElm_js.lastElementChild
                        var target_id = target.id
                        target.remove()
                        var sendData = {
                                        "type" : "redo",
                                        "id": target_id
                                    }
                        delete drawingData[target_id]
                        sendOnDatachannel(sendData);
                        saveBoardData();
                })
            }

            redo()

            function imageUpload() {
                document.getElementById("image_catch").addEventListener('click', () => {
                    document.getElementById('file-select-input').click();
                })

                document.getElementById('file-select-input').addEventListener('change', (event) => {
                    const files = event.target.files;
                    if (files.length > 0) {
                        var viewBox = getViewBox()
                        var viewBox_x = viewBox[0]
                        var viewBox_y = viewBox[1]
                        previewAndInsert(files, 200 + viewBox_x, 200 + viewBox_y);
                    }
                    event.target.files = null;
                    event.target.value = null;
                });

                document.getElementById("drawingCanvas").addEventListener('dragover', (event) => {
                    event.preventDefault();
                    event.dataTransfer.dropEffect = 'copy';
                });

                document.getElementById("drawingCanvas").addEventListener('drop', (event) => {
                    event.preventDefault();
                    const files = event.dataTransfer.files;
                    if (files.length === 0) {
                        return;
                    }

                    // 画像ファイルのみ OK
                    if (!files[0].type.match(/image\/*/)) {
                        return;
                    }
                    const x = parseInt(getPositionXOnSvg(event));
                    const y = parseInt(getPositionYOnSvg(event));

                    previewAndInsert(files, x, y);
                });

                const previewAndInsert = (files, x, y) => {
                    var id = ""
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const image = new Image();
                        var saveImageData = {};
                        image.onload = function () {
                            id = Math.random().toString(32).substring(2);
                            String.prototype.bytes = function () {
                                return (encodeURIComponent(this).replace(/%../g, "x").length);
                            }
                            var href = reader.result;
                            saveImageData.href = href;
                            saveImageData.id = id;
                            saveImageData.type = "image";
                            var w = 0;
                            h = 0;
                            if (this.width > 300 || this.height > 300) {
                                var aspect = this.width / this.height;
                                if (aspect > 1) {
                                    w = 300;
                                    h = 300 / aspect;
                                    x -= w / 2;
                                    y -= h / 2;
                                } else {
                                    w = 300;
                                    h = 300 / aspect;
                                    x -= w / 2;
                                    y -= h / 2;
                                }
                            } else {
                                w = this.width;
                                h = this.height;
                                x -= this.width / 2;
                                y -= this.height / 2;
                            }
                            saveImageData.x = 0;
                            saveImageData.y = 0;
                            saveImageData.width = w;
                            saveImageData.height = h;
                            saveImageData.cx = x;
                            saveImageData.cy = y;
                            drawingData[id] = saveImageData;
                            saveBoardData();
                            // roomSocket.send(JSON.stringify(saveImageData));
                            // sendOnDatachannel(saveImageData);
                            createImage(saveImageData.cx, saveImageData.cy, saveImageData.x, saveImageData.y, saveImageData.width, saveImageData.height, saveImageData.href, saveImageData.id);
                            var sendImageData = saveImageData;
                            sendImageData.href = ""
                            var len = href.length;
                            var count = Math.floor(len / 64000);
                            console.log("---------");
                            saveImageData.count = count;
                            sendOnDatachannel(sendImageData);
                            sendImageDataChunk(64000, href, id)
                        }
                        image.src = reader.result;
                    }
                    reader.readAsDataURL(files[0]);
                }
            }

            imageUpload();

            function getPageX(e) {
                var pageX = 0;
                if (e.changedTouches) {
                    pageX = e.changedTouches[0].pageX;
                } else {
                    pageX = e.pageX;
                }
                return pageX;
            }

            function getPositionXOnSvg(e) {
                var x = getPageX(e)
                var left = svgElm.position().left
                var svg_w = svgElm_js.clientWidth
                var viewBox = getViewBox()
                var pageX_aspect =  viewBox[2]/svg_w
                var viewBox_x = viewBox[0]
                var result = (x - left)*pageX_aspect+viewBox_x;
                return result
            }

            function getPositionXOnSvgByX(page_x) {
                var left = svgElm.position().left
                var svg_w = svgElm_js.clientWidth
                var viewBox = getViewBox()
                var pageX_aspect =  viewBox[2]/svg_w
                var viewBox_x = viewBox[0]
                var result = (page_x - left)*pageX_aspect+viewBox_x;
                return result
            }

            function getPageY(e) {
                var pageY = 0;
                if (e.changedTouches) {
                    pageY = e.changedTouches[0].pageY;
                } else {
                    pageY = e.pageY;
                }
                return pageY;
            }

            function getPositionYOnSvg(e) {
                var y = getPageY(e)
                var top = svgElm.position().top
                var svg_w = svgElm_js.clientWidth
                var viewBox = getViewBox()
                var svg_h = svgElm_js.clientHeight
                var pageY_aspect =  viewBox[3]/svg_h
                var viewBox_y = viewBox[1]
                var result = (y - top)*pageY_aspect + viewBox_y;
                return result
            }

            function getPositionYOnSvgByY(page_y) {
                var top = svgElm.position().top
                var svg_w = svgElm_js.clientWidth
                var viewBox = getViewBox()
                var svg_h = svgElm_js.clientHeight
                var pageY_aspect =  viewBox[3]/svg_h
                var viewBox_y = viewBox[1]
                var result = (page_y - top)*pageY_aspect + viewBox_y;
                return result
            }

            function createImage(cx, cy, x, y,  w, h, href, id) {
                var image_elm = document.createElementNS("http://www.w3.org/2000/svg", "image");
                image_elm.setAttribute("href", href);
                image_elm.setAttribute("id", id);
                image_elm.setAttribute("width", w);
                image_elm.setAttribute("height", h);
                image_elm.setAttribute("x", cx);
                image_elm.setAttribute("y", cy);
                var transform = image_elm.transform.baseVal.createSVGTransformFromMatrix(SVGMatrixCreate())
                if (!image_elm.hasAttribute("transform")) {
                    image_elm.transform.baseVal.appendItem(transform);
                }
                var Matrix = image_elm.transform.baseVal[0].matrix;
                Matrix.e += x;
                Matrix.f += y;
                document.getElementById('drawingCanvas').appendChild(image_elm);
            }

            function createTextBox(cx, cy, x, y, id, text) {
                var text_box = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text_box.setAttribute("x", cx);
                text_box.setAttribute("y", cy);
                text_box.setAttribute("font-size", 20);
                text_box.setAttribute("fill", "#666666");
                text_box.setAttribute("id", id);
                text_box.textContent = text;
                var transform = text_box.transform.baseVal.createSVGTransformFromMatrix(SVGMatrixCreate())
                if (!text_box.hasAttribute("transform")) {
                    text_box.transform.baseVal.appendItem(transform);
                }
                var Matrix = text_box.transform.baseVal[0].matrix;
                Matrix.e += x;
                Matrix.f += y;
                svgElm.append(text_box);
            }


            function createRect(cx, cy, w, h, elm, id, fill, stroke, stroke_width) {
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', cx);
                rect.setAttribute('y', cy);
                rect.setAttribute('width', w);
                rect.setAttribute('height', h);
                rect.setAttribute('fill', fill);
                rect.setAttribute('stroke', stroke);
                rect.setAttribute('stroke-width', stroke_width);
                rect.setAttribute('stroke-dasharray', "none");//破線 10,10 etc
                rect.setAttribute('stroke-linejoin', 'miter'); //角 miter round bevel inherit
                rect.setAttribute('stroke-linecap', 'butt'); //切れ目 butt round square inherit
                rect.setAttribute('opacity', 1);
                rect.setAttribute('fill-opacity', 1);
                rect.setAttribute('stroke-opacity', 1);
                rect.setAttribute('class', "catch");
                rect.setAttribute('id', id);
                elm.append(rect);
            }

            function sendOnDatachannel(data) {
                if (!isEmpty(dataChannelList)) {
                    for (let user_name in dataChannelList) {
                        dataChannelList[user_name].send(JSON.stringify(data));
                    }
                }
            }

            function isEmpty(obj) {
                return !Object.keys(obj).length;
            }

            function sendImageDataChunk(chunk, data, id) {
                var len = data.length;
                var count = Math.floor(len/chunk);
                for (var i = 0; i < count + 1; i++) {
                    var parts = data.substring(i*chunk, (i+1)*chunk);
                    var sendData = {"type": "image_href", "href": parts, "count": i, "id": id};
                    sendOnDatachannel(sendData);
                    if (i === count) {
                        var parts = data.substring(i*chunk, len);
                        var sendData = {"type": "image_href", "href": parts, "count": i, "id": id};
                        sendOnDatachannel(sendData);
                    }
                }
            }





            roomSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                switch (data.type) {
                    case "shareData":
                        drawingData = data.data;
                        console.log("share");
                        break;
                    default:
                        console.log("no data");
                        break;
                }
            };

            function logOnView(content, time, className) {
                Materialize.toast(content, time, className)
            }

        });
    </script>
</body>

</html>