<!DOCTYPE html>
<html>

<head>

  <title>WebRTC</title>

<style>
    body {
        font-family: sans-serif;
    }

    video {
        max-width: 100%;
        width: 320px;
    }
</style>

</head>

<body>

  <h1>Realtime communication with WebRTC</h1>

  <div id="videos">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>
  <button id="startButton">Start</button>

  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script>

var localVideo = document.querySelector('#localVideo');
var remoteVideo = document.querySelector('#remoteVideo');
const startButton = document.getElementById('startButton');
var pc;
var rpc;
var remoteStream;
var localStream;

navigator.mediaDevices.getUserMedia({
  audio: false,
  video: true
}).then(gotStream)
.catch(function(e) {
  alert('getUserMedia() error: ' + e.name);
});

function gotStream(stream) {
  console.log('Adding local stream.');
  localStream = stream;
  localVideo.srcObject = stream;
}

startButton.addEventListener('click', maybeStart);

function maybeStart() {
  console.log('>>>>>>> maybeStart() ');
    console.log('>>>>>> creating peer connection');
    createPeerConnection();
    pc.addStream(localStream);
    doCall();
}

function createPeerConnection() {
  try {
    pc = new RTCPeerConnection(null);
    rpc = new RTCPeerConnection(null);
    rpc.onicecandidate = handleIceCandidate;
    pc.onicecandidate = handleIceCandidate;
    rpc.onaddstream = handleRemoteStreamAdded;
    // rpc.onremovestream = handleRemoteStreamRemoved;
    pc.onicecandidate = handleIceCandidate;
    console.log('Created RTCPeerConnnection');
  } catch (e) {
    console.log('Failed to create PeerConnection, exception: ' + e.message);
    alert('Cannot create RTCPeerConnection object.');
    return;
  }
}

function handleIceCandidate(event) {
  console.log('icecandidate event: ', event);
  if (event.candidate) {
    var candidate = new RTCIceCandidate(event.candidate);
    pc.addIceCandidate(candidate);
  } else {
    console.log('End of candidates.');
  }
}

function doCall() {
  console.log('Sending offer to peer');
  pc.createOffer(setLocalAndSendMessage, handleCreateOfferError);
}

function doAnswer() {
  console.log('Sending answer to peer.');
  rpc.createAnswer().then(
    setRemoteAndSendMessage,
    onCreateSessionDescriptionError
  );
}

function setLocalAndSendMessage(sessionDescription) {
  pc.setLocalDescription(sessionDescription);
  rpc.setRemoteDescription(sessionDescription)
  doAnswer();
}

function setRemoteAndSendMessage(sessionDescription) {
  pc.setRemoteDescription(sessionDescription);
  rpc.setLocalDescription(sessionDescription)
}

function onCreateSessionDescriptionError(error) {
  console.log('Failed to create session description: ' + error.toString());
}

function handleRemoteStreamAdded(event) {
  console.log('Remote stream added.');
  remoteStream = event.stream;
  remoteVideo.srcObject = remoteStream;
}

function handleCreateOfferError(event) {
  console.log('createOffer() error: ', event);
}
</script>
</body>
</html>