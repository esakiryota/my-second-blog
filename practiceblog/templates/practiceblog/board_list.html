{% extends 'practiceblog/base.html' %}
{% block title %}ボードリスト{% endblock %}
{% block content %}
<nav>
    <div class="nav-wrapper">
        <form>
            <div class="input-field">
                <input class="white" id="search" type="search" placeholder="検索">
                <label class="label-icon" for="search"><i class="material-icons">search</i></label>
                <i class="material-icons">close</i>
            </div>
        </form>
    </div>
</nav>
<div>
    <div class="row" id="room_collection">
    </div>
</div>
{{ token_list|json_script:"token_list"}}
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script>
     $(function () {
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }


        function ajax(data, url, type, doneFunc, token) {
                var csrf_token = getCookie("csrftoken");
                var csrftoken2 = getCookie("csrftoken");
                console.log(`csrftoken2:${csrftoken2}`);
                $.ajax({
                    url: url,
                    type: type,
                    data: data,
                    beforeSend: function (xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrf_token);
                        }
                    },
                    dataType: 'json',
                    contentType: "application/json",
                }).done(function (response) {

                    if (data.error) {
                        console.log("ERROR");
                    }
                    else {
                        doneFunc(response.data, token);
                    }

                }).fail(function (xhr, status, error) {
                    console.log(status + ":" + error + ":" + xhr);
                });
            }

            var response_data;
            var token_list = JSON.parse(document.getElementById('token_list').textContent);
            console.log(token_list);

            var search = document.getElementById("search")
            var room_collection = document.getElementById("room_collection")
            var read_more = document.getElementById("read_more")
            var page = 0
            var num = 1
            new_user_list = ``

            function userDisplay(data) {
                user_list = data
                console.log(data);

                for (var i = 0; i < user_list.length; i++) {
                    new_user_list += `<a id="token" class="room" href="/myboard/${user_list[i].token}"><div class="col s12 m6 l4"><div class="card"><div class="card-image">
                
                    <svg id="${user_list[i].token}" style="width: 100%; height: 20%;" viewBox="0 0 666 333"></svg>
                  <div class="card-content">
          <p class="black-text">${user_list[i].username}ボード</p>
        </div>
                </div></div></div></a>`
                }

                room_collection.innerHTML = new_user_list

                for (var i = 0; i < user_list.length; i++) {
                    loadRoom(user_list[i].token);
                }
            }

            userDisplay(token_list)

            search.addEventListener("input", function() {
                console.log(this.value);
                new_user_list = ``
                page = 0
                var data = {
                        str : this.value
                    }
                const apiUrl = '/board_list/api/search'
                response_data = ajax(data, apiUrl, "GET", userDisplay)
            })

            // var svgElm = $("#drawingCanvas")
            // var token = JSON.parse(document.getElementById('token').textContent);

            function defultDraw(data, token) {
                console.log(token);
                var svgElm = $(`#${token}`)
                console.log(svgElm);
                Object.keys(data).forEach(function(key) {
                    //初期データをjsonfileに書き込む用のデータに加える
                    var value = data[key];
                    console.log(value);
                    var draw_type = value.type
                    switch (draw_type) {
                        case "draw":
                            var pathElm = document.createElementNS("http://www.w3.org/2000/svg", "path");
                            svgElm.append(pathElm);
                            console.log(value);
                            svgElm.find("path:last").attr({
                                "id": key,
                                "d": value.d, 
                                "fill": "none",
                                "stroke": value.stroke, 
                                "stroke-width": value.strokeSize, 
                                "stroke-linecap": "round" 
                            });
                            var transform = pathElm.transform.baseVal.createSVGTransformFromMatrix(SVGMatrixCreate())
                            if (!pathElm.hasAttribute("transform")) {
                                pathElm.transform.baseVal.appendItem(transform);
                            }

                            // var Matrix = target.transform.matrix;
                            var Matrix = pathElm.transform.baseVal[0].matrix;
                            Matrix.e = value.x;
                            Matrix.f = value.y;
                            break;
                        case "image":
                            var imageElm = document.createElementNS("http://www.w3.org/2000/svg", "image");
                            imageElm.setAttribute("href", value.href);
                            imageElm.setAttribute("id", value.id);
                            imageElm.setAttribute("width", value.width);
                            imageElm.setAttribute("height", value.height);
                            imageElm.setAttribute("x", value.cx);
                            imageElm.setAttribute("y", value.cy);
                            svgElm.append(imageElm);
                            var transform = imageElm.transform.baseVal.createSVGTransformFromMatrix(SVGMatrixCreate())
                            if (!imageElm.hasAttribute("transform")) {
                                imageElm.transform.baseVal.appendItem(transform);
                            }

                            // var Matrix = target.transform.matrix;
                            var Matrix = imageElm.transform.baseVal[0].matrix;
                            Matrix.e = value.x;
                            Matrix.f = value.y;
                            break;
                        case "textBox":
                            createTextBox(value.cx, value.cy, value.x, value.y, value.id, value.text);
                            break;
                        case "":
                            svgElm.html("");
                            break;
                        default:
                            console.log("no type");
                    }
            }, data.data)
          }

          function loadRoom(token) {
                const apiUrl =
                    '/rooms/api/'
                    + token
                    + '/load'
                loadingData = ajax("dummy", apiUrl, "GET", defultDraw, token)
            }

            window.addEventListener('load', function () {
                loadRoom()
              });

            function createTextBox(cx, cy, x, y, id, text) {
                var text_box = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text_box.setAttribute("x", cx);
                text_box.setAttribute("y", cy);
                text_box.setAttribute("font-size", 20);
                text_box.setAttribute("fill", "#666666");
                text_box.setAttribute("id", id);
                text_box.textContent = text;
                var transform = text_box.transform.baseVal.createSVGTransformFromMatrix(SVGMatrixCreate())
                if (!text_box.hasAttribute("transform")) {
                    text_box.transform.baseVal.appendItem(transform);
                }
                var Matrix = text_box.transform.baseVal[0].matrix;
                Matrix.e += x;
                Matrix.f += y;
                svgElm.append(text_box);
            }

            function SVGMatrixCreate(a, b, c, d, e, f) {
                var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                var mtx = svg.createSVGMatrix();
                if (a !== undefined) mtx.a = a;
                if (b !== undefined) mtx.b = b;
                if (c !== undefined) mtx.c = c;
                if (d !== undefined) mtx.d = d;
                if (e !== undefined) mtx.e = e;
                if (f !== undefined) mtx.f = f;
                return mtx;
            }



    })
</script>
{% endblock %}